generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Ticket {
  id           String         @id @default(uuid())
  ticketNumber Int?
  title        String         @db.VarChar(50)
  description  String         @db.VarChar(300)
  img          String?        @db.VarChar(250)
  comment      String?        @db.VarChar(300)
  type         TicketType
  priority     TicketPriority
  status       TicketStatus
  startDate    DateTime?
  endDate      DateTime?
  requestDays  Int?
  approvedDays Int?
  view         Boolean?
  sendById     String?
  sendToId     String?
  companyId    String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  reviewed     Boolean?
  // No cascada: El usuario no se elimina si se elimina el ticket
  sendBy       User?          @relation("TicketsSentBy", fields: [sendById], references: [id], onDelete: SetNull)
  // No cascada: El usuario no se elimina si se elimina el ticket
  sendTo       User?          @relation("TicketsSentTo", fields: [sendToId], references: [id], onDelete: SetNull)
  // ⚠️ NO CASCADE: Si se elimina la compañía, el ticket se desasocia (companyId pasa a null)
  company      Company?       @relation(fields: [companyId], references: [id], onDelete: SetNull)
}

model User {
  id                   String        @id @default(uuid())
  username             String        @unique
  email                String        @unique
  password             String
  role                 UserRole      @default(USER)
  isActive             Boolean       @default(true)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  companyId            String?
  createdCompanies     Company[]     @relation("CompanyCreatedBy")
  assignedEquipments   Equipment[]
  assignedMaintenances Maintenance[]
  assignedNetworks     Network[]
  person               Person?
  ticketsSentBy        Ticket[]      @relation("TicketsSentBy")
  ticketsSentTo        Ticket[]      @relation("TicketsSentTo")
  // ⚠️ NO CASCADE: Solo desasociar usuarios, no eliminarlos
  company              Company?      @relation("CompanyUsers", fields: [companyId], references: [id], onDelete: SetNull)
}

model Person {
  id           String       @id @default(uuid())
  userId       String       @unique
  firstName    String?
  lastName    String?
  fullName     String?
  contactEmail String?
  phoneNumber  String?
  departmentId String?
  position     String?
  status       PersonStatus @default(Activo)
  userCode     String       @unique
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  // Si se elimina el departamento, la persona pierde la asignación
  department   Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Company {
  id               String            @id @default(uuid())
  code             String            @unique @default("CO001")
  name             String            @unique
  address          String?
  phone            String?
  email            String?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  createdByUserId  String?
  // Si se elimina el usuario creador, la compañía sigue existiendo
  createdBy        User?             @relation("CompanyCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  // ✅ CASCADE: Elimina departamentos con la compañía
  departments      Department[]      
  // ✅ CASCADE: Elimina documentos con la compañía
  documents        Document[]        
  // ✅ CASCADE: Elimina equipos con la compañía
  equipments       Equipment[]       
  // ✅ CASCADE: Elimina licencias con la compañía
  licenses         License[]         
  // ✅ CASCADE: Elimina mantenimientos con la compañía
  maintenances     Maintenance[]     
  // ✅ CASCADE: Elimina redes con la compañía
  networks         Network[]         
  // ✅ CASCADE: Elimina proveedores de red con la compañía
  networkProviders NetworkProvider[] 
  // ⚠️ NO CASCADE: Solo desasociar usuarios
  users            User[]            @relation("CompanyUsers")
  // ⚠️ NO CASCADE: Si se elimina la compañía, los tickets se desasocian (companyId pasa a null)
  tickets          Ticket[]
}

model Department {
  id          String   @id @default(uuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  companyId   String
  // ✅ CASCADE: Elimina departamento con la compañía
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  // Si se elimina el departamento, las personas pierden la asignación
  persons     Person[]
}

model Equipment {
  id               String          @id @default(uuid())
  type             String
  brand            String
  model            String
  serialNumber     String          @unique
  plateNumber      String?         @unique
  location         String?
  status           EquipmentStatus @default(ACTIVE)
  acquisitionDate  DateTime?
  warrantyDetails  String?
  qrCode           String?
  cost             Decimal?        @default(0.00)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  companyId        String
  assignedToUserId String?
  endUser          String?
  operatingSystem  String?
  // ✅ CASCADE: Elimina documentos con el equipo
  documents        Document[]      
  // No cascada: El usuario no se elimina si se elimina el equipo
  assignedToUser   User?           @relation(fields: [assignedToUserId], references: [id], onDelete: SetNull)
  // ✅ CASCADE: Elimina equipo con la compañía
  company          Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  // ✅ CASCADE: Elimina mantenimientos con el equipo
  maintenances     Maintenance[]   
}

model Maintenance {
  id               String            @id @default(uuid())
  title            String
  description      String?
  type             MaintenanceType
  status           MaintenanceStatus @default(SCHEDULED)
  scheduledDate    DateTime
  completionDate   DateTime?
  cost             Decimal?          @default(0.00)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  equipmentId      String
  assignedToUserId String?
  companyId        String
  // No cascada: El usuario no se elimina
  assignedToUser   User?             @relation(fields: [assignedToUserId], references: [id], onDelete: SetNull)
  // ✅ CASCADE: Elimina con la compañía
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  // ✅ CASCADE: Elimina con el equipo
  equipment        Equipment         @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
}

model Document {
  id          String     @id @default(uuid())
  title       String
  description String?
  fileUrl     String
  fileType    String?
  category    String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  companyId   String
  equipmentId String?
  // ✅ CASCADE: Elimina con la compañía
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  // ✅ CASCADE: Elimina con el equipo
  equipment   Equipment? @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
}

model License {
  id             String    @id @default(uuid())
  softwareName   String
  licenseKey     String    @unique
  provider       String?
  activationDate DateTime
  expirationDate DateTime?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  companyId      String
  // ✅ CASCADE: Elimina con la compañía
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model NetworkProvider {
  id            String    @id @default(uuid())
  name          String
  providerIp    String?
  dnsGateway    String?
  speed         String?
  cost          Decimal?  @default(0.00)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now())
  meshDevices   String?
  switchDevices String?
  companyId     String
  // ✅ CASCADE: Elimina redes con el proveedor
  networks      Network[]
  // ✅ CASCADE: Elimina con la compañía
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([name, companyId])
}

model Network {
  id               String              @id @default(uuid())
  name             String
  ipAddress        String              @unique
  macAddress       String?
  deviceType       NetworkDeviceType   @default(OTHER)
  status           NetworkDeviceStatus @default(UNKNOWN)
  location         String?
  description      String?
  serialNumber     String?
  brand            String?
  purchaseDate     DateTime?
  warrantyEndDate  DateTime?
  notes            String?
  model            String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  companyId        String
  assignedToUserId String?
  providerId       String?
  // No cascada: El usuario no se elimina
  assignedToUser   User?               @relation(fields: [assignedToUserId], references: [id], onDelete: SetNull)
  // ✅ CASCADE: Elimina con la compañía
  company          Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  // ✅ CASCADE: Elimina con el proveedor
  provider         NetworkProvider?    @relation(fields: [providerId], references: [id], onDelete: Cascade)
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
  SUPER_ADMIN
}

enum PersonStatus {
  Activo
  Inactivo
}

enum TicketType {
  vacations
  permission
  ticket
}

enum TicketPriority {
  urgent
  high
  medium
  low
  trivial
}

enum TicketStatus {
  open
  pending
  approved
  rejected
  closed
}

enum EquipmentStatus {
  ACTIVE
  IN_MAINTENANCE
  DISPOSED
  DAMAGED
  ASSIGNED
  STORAGE
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum NetworkDeviceType {
  ROUTER
  SWITCH
  FIREWALL
  ACCESS_POINT
  SERVER
  PRINTER
  IP_PHONE
  CAMERA
  OTHER
}

enum NetworkDeviceStatus {
  ONLINE
  OFFLINE
  MAINTENANCE
  DECOMMISSIONED
  UNKNOWN
}